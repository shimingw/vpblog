<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nginx | 嘻哈工程师</title>
    <meta name="description" content="嘻哈工程师的博客">
    <meta name="generator" content="VuePress 1.4.0">
    <script type="text/javascript" src="/baidu-analytics.js" async="async"></script>
  <link rel="icon" href="/icons/favicon.ico">
  <meta name="referrer" content="no-referrer">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/192.png">
  <meta name="msapplication-TileImage" content="/icons/144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.cb726fc1.css" as="style"><link rel="preload" href="/assets/js/app.82d5831e.js" as="script"><link rel="preload" href="/assets/js/2.8423ab85.js" as="script"><link rel="preload" href="/assets/js/66.94449ac4.js" as="script"><link rel="preload" href="/assets/js/5.d4f27e5e.js" as="script"><link rel="prefetch" href="/assets/js/10.584dfaad.js"><link rel="prefetch" href="/assets/js/11.21934ff8.js"><link rel="prefetch" href="/assets/js/12.622d7aaf.js"><link rel="prefetch" href="/assets/js/13.4b1c45af.js"><link rel="prefetch" href="/assets/js/14.bdb8c56d.js"><link rel="prefetch" href="/assets/js/15.909c20b4.js"><link rel="prefetch" href="/assets/js/16.4a775862.js"><link rel="prefetch" href="/assets/js/17.1ab27502.js"><link rel="prefetch" href="/assets/js/18.a53dfd48.js"><link rel="prefetch" href="/assets/js/19.17d17687.js"><link rel="prefetch" href="/assets/js/20.f942fb19.js"><link rel="prefetch" href="/assets/js/21.98ca7d4f.js"><link rel="prefetch" href="/assets/js/22.111cba00.js"><link rel="prefetch" href="/assets/js/23.77771bff.js"><link rel="prefetch" href="/assets/js/24.291a01c4.js"><link rel="prefetch" href="/assets/js/25.4d9e2913.js"><link rel="prefetch" href="/assets/js/26.8594e444.js"><link rel="prefetch" href="/assets/js/27.e3dd80d3.js"><link rel="prefetch" href="/assets/js/28.c7ff221a.js"><link rel="prefetch" href="/assets/js/29.7ccb2086.js"><link rel="prefetch" href="/assets/js/3.964dd521.js"><link rel="prefetch" href="/assets/js/30.95adae2a.js"><link rel="prefetch" href="/assets/js/31.a46ba375.js"><link rel="prefetch" href="/assets/js/32.f6bee87d.js"><link rel="prefetch" href="/assets/js/33.844214e5.js"><link rel="prefetch" href="/assets/js/34.17e3b6e3.js"><link rel="prefetch" href="/assets/js/35.146bfc1a.js"><link rel="prefetch" href="/assets/js/36.54d1b090.js"><link rel="prefetch" href="/assets/js/37.a97640bf.js"><link rel="prefetch" href="/assets/js/38.e24fef7e.js"><link rel="prefetch" href="/assets/js/39.20879433.js"><link rel="prefetch" href="/assets/js/4.a24a1734.js"><link rel="prefetch" href="/assets/js/40.7940f596.js"><link rel="prefetch" href="/assets/js/41.4d935934.js"><link rel="prefetch" href="/assets/js/42.1d8ed827.js"><link rel="prefetch" href="/assets/js/43.c2d3435d.js"><link rel="prefetch" href="/assets/js/44.5bba9b0f.js"><link rel="prefetch" href="/assets/js/45.ab7ad8fd.js"><link rel="prefetch" href="/assets/js/46.2a751e0d.js"><link rel="prefetch" href="/assets/js/47.4d289900.js"><link rel="prefetch" href="/assets/js/48.fc7073fe.js"><link rel="prefetch" href="/assets/js/49.ee62096f.js"><link rel="prefetch" href="/assets/js/50.8081383a.js"><link rel="prefetch" href="/assets/js/51.50b4ac6d.js"><link rel="prefetch" href="/assets/js/52.2a1c3e04.js"><link rel="prefetch" href="/assets/js/53.2a054661.js"><link rel="prefetch" href="/assets/js/54.2bac38f3.js"><link rel="prefetch" href="/assets/js/55.191935a2.js"><link rel="prefetch" href="/assets/js/56.176a7439.js"><link rel="prefetch" href="/assets/js/57.1b789337.js"><link rel="prefetch" href="/assets/js/58.a8648607.js"><link rel="prefetch" href="/assets/js/59.4c25c46a.js"><link rel="prefetch" href="/assets/js/6.f2102c70.js"><link rel="prefetch" href="/assets/js/60.a83459ff.js"><link rel="prefetch" href="/assets/js/61.1fb92025.js"><link rel="prefetch" href="/assets/js/62.b6e1b70d.js"><link rel="prefetch" href="/assets/js/63.2420abcf.js"><link rel="prefetch" href="/assets/js/64.110271ce.js"><link rel="prefetch" href="/assets/js/65.51265dc4.js"><link rel="prefetch" href="/assets/js/67.c86b38fc.js"><link rel="prefetch" href="/assets/js/68.7563e776.js"><link rel="prefetch" href="/assets/js/69.28b5b0e2.js"><link rel="prefetch" href="/assets/js/7.ed32b398.js"><link rel="prefetch" href="/assets/js/70.25071617.js"><link rel="prefetch" href="/assets/js/71.48c29f8d.js"><link rel="prefetch" href="/assets/js/72.2fbc6430.js"><link rel="prefetch" href="/assets/js/73.f7f156cb.js"><link rel="prefetch" href="/assets/js/74.0b396520.js"><link rel="prefetch" href="/assets/js/75.3f782a2d.js"><link rel="prefetch" href="/assets/js/8.63fa3eff.js"><link rel="prefetch" href="/assets/js/9.07ec0533.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cb726fc1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">嘻哈工程师</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  最新
</a></div><div class="nav-item"><a href="/archives/" class="nav-link">
  归档
</a></div> <a href="https://github.com/shimingw/vpblog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  最新
</a></div><div class="nav-item"><a href="/archives/" class="nav-link">
  归档
</a></div> <a href="https://github.com/shimingw/vpblog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/docs/2020-02-07-服务器搭建-SSL的申请与部署/" class="sidebar-link">SSL的申请与部署</a></li><li><a href="/docs/2019-07-01-服务器搭建-nginx/" class="active sidebar-link">nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#http-协议" class="sidebar-link">http 协议</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#常用变量" class="sidebar-link">常用变量</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#常用指令" class="sidebar-link">常用指令</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#负载均衡" class="sidebar-link">负载均衡</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#健康检查" class="sidebar-link">健康检查</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#反向代理" class="sidebar-link">反向代理</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#https-配置" class="sidebar-link">Https 配置</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#适配-pc-与移动环境" class="sidebar-link">适配 PC 与移动环境</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#优化手段" class="sidebar-link">优化手段</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#配置-gzip" class="sidebar-link">配置 gzip</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#禁用页面资源请求的记录" class="sidebar-link">禁用页面资源请求的记录</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#禁用成功请求的日志记录" class="sidebar-link">禁用成功请求的日志记录</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#使用缓冲来最小化-i-o-操作" class="sidebar-link">使用缓冲来最小化 I / O 操作</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#限制特定-url-的带宽" class="sidebar-link">限制特定 URL 的带宽</a></li><li class="sidebar-sub-header"><a href="/docs/2019-07-01-服务器搭建-nginx/#使用-http-2" class="sidebar-link">使用 HTTP/2</a></li></ul></li></ul></li><li><a href="/docs/2018-03-25-服务器搭建-Linux/" class="sidebar-link">Linux</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="http-协议"><a href="#http-协议" class="header-anchor">#</a> http 协议</h2> <p><strong>请求头</strong></p> <p><code>Connection</code>：close 和 keep-alive。是否支持长连接。长连接可以重用 http 请求资源，减少资源开销
<code>Host</code>：发起请求的域名或者 ip
<code>etag</code>：被请求变量的实体值，nginx 会给每个静态资源打上一个 etag 标签，客户端每次请求的时候会带上<code>If-None-Match</code>如果 nginx 的资源没有发生变化，则 Etag 标签不会发生改变。浏览器会返回 304，服务器就从缓存中读取资源。</p> <h2 id="常用变量"><a href="#常用变量" class="header-anchor">#</a> 常用变量</h2> <ul><li><code>$http_host</code>：客户端请求头中携带的 host</li> <li><code>$host</code>：nginx 服务器的域名或者 ip</li> <li><code>$proxy_port</code>：<strong>proxy_pass</strong>对应后端服务器的端口</li> <li><code>$remote_addr</code>：用户 ip</li> <li><code>$proxy_add_x_forwarded_for</code>：添加用户 ip 和每次 nginx 反向代理服务器的 ip 用逗号隔开，起到一个溯源的作用。</li></ul> <h2 id="常用指令"><a href="#常用指令" class="header-anchor">#</a> 常用指令</h2> <p><strong>proxy_set_header</strong></p> <blockquote><p>允许重新定义或者添加发往后端服务器的请求头</p></blockquote> <p>Host</p> <p>默认情况下，只有两个请求头会被重新定义：<code>Host</code>和<code>Connection</code></p> <p>如果不想改变请求头“Host”的值，可以这样来设置：
<code>proxy_set_header Host $http_host;</code></p> <p><strong>websocket</strong></p> <p>nginx 代理转发 websocket 请求</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
<span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;upgrade&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>长链接如果长时间没有响应会被<code>nginx</code>中断
解决方案 1
修改<code>timeout</code>时间</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">proxy_connect_timeout</span><span class="token punctuation">;</span>
<span class="token keyword">proxy_read_timeout</span><span class="token punctuation">;</span>
<span class="token keyword">proxy_send_timeout</span><span class="token punctuation">;</span>
</code></pre></div><p>解决方案 2
定时发送心跳包</p> <p><strong>proxy_connect_timeout</strong></p> <blockquote><p>设置与后端服务器建立连接的超时时间。应该注意这个超时一般不可能大于 75 秒。默认 60s</p></blockquote> <p><strong>proxy_read_timeout</strong></p> <blockquote><p>定义从后端服务器读取响应的超时。此超时是指相邻两次读操作之间的最长时间间隔，而不是整个响应传输完成的最长时间。如果后端服务器在超时时间段内没有传输任何数据，连接将被关闭。</p></blockquote> <p><strong>proxy_send_timeout</strong></p> <blockquote><p>定义向后端服务器传输请求的超时。此超时是指相邻两次写操作之间的最长时间间隔，而不是整个请求传输完成的最长时间。如果后端服务器在超时时间段内没有接收到任何数据，连接将被关闭。</p></blockquote> <p><strong>proxy_pass</strong></p> <blockquote><p>设置后端服务器的协议和地址</p></blockquote> <h2 id="负载均衡"><a href="#负载均衡" class="header-anchor">#</a> 负载均衡</h2> <p><strong>轮询（默认）</strong></p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backserver <span class="token punctuation">{</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>权重 weight</strong></p> <p>指定不同 ip 的权重，权重与访问比成正相关，权重越高，访问越大，适用于不同性能的机器。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backserver <span class="token punctuation">{</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span> weight<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.2</span> weight<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>响应时间来分配</strong></p> <p>公平竞争，谁相应快，谁处理，不过这种方式需要依赖到第三方插件<code>nginx-upstream-fair</code>，需要先安装。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backserver <span class="token punctuation">{</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.2</span><span class="token punctuation">;</span>
    fair<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="健康检查"><a href="#健康检查" class="header-anchor">#</a> 健康检查</h2> <p><strong>Nginx</strong>自带<code>ngx_http_upstream_module</code> （健康检测模块）本质上服务器心跳的检查，通过定期轮询向集群里的服务器发送健康检查请求,来检查集群中是否有服务器处于异常状态。</p> <p>如果检测出其中某台服务器异常,那么在通过客户端请求 nginx 反向代理进来的都不会被发送到该服务器上（直至下次轮训健康检查正常）</p> <p><strong>判断异常依据<code>proxy_next_upstream</code>的配置</strong></p> <div class="language- extra-class"><pre class="language-text"><code>Syntax: proxy_next_upstream error | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | non_idempotent | off ...;
Default:    proxy_next_upstream error timeout;
Context:    http, server, location
</code></pre></div><ul><li>error:在与服务器建立连接，向其传递请求或读取响应标头时发生错误;</li> <li>timeout:在与服务器建立连接，向其传递请求或读取响应头时发生超时;</li> <li>invalid_header:服务器返回空响应或无效响应;</li> <li>http_500:服务器返回了带有代码 500 的响应;</li> <li>http_502:服务器返回具有代码 502 的响应;</li> <li>HTTP_503:服务器返回具有代码 503 的响应;</li> <li>http_504:服务器返回具有代码 504 的响应;</li> <li>http_403:服务器返回带有代码 403 的响应;</li> <li>http_404:服务器返回具有代码 404 的响应;</li> <li>non_idempotent:通常，如果请求已经被发送到上游服务器（1.9.13），则具有非幂等方法的请求（POST，LOCK，PATCH）不被传递到下一个服务器;启用此选项明确允许重试此类请求;</li> <li>off:禁用将请求传递到下一个服务器。</li></ul> <p><strong>配置参数</strong></p> <ul><li>max_fails：设定 Nginx 与服务器通信的尝试失败的次数，默认为：1 次</li> <li>fail_timeout：设定服务器被认为不可用的时间段以及统计失败尝试次数的时间段，默认为 10s</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backserver<span class="token punctuation">{</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span>  max_fails<span class="token operator">=</span><span class="token number">1</span> fail_timeout<span class="token operator">=</span><span class="token number">40</span>s<span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.2</span>  max_fails<span class="token operator">=</span><span class="token number">1</span> fail_timeout<span class="token operator">=</span><span class="token number">40</span>s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="反向代理"><a href="#反向代理" class="header-anchor">#</a> 反向代理</h2> <p>将一个请求转发到另一个资源（可以是另一台服务器，也可以使本服务器的指定目录）</p> <p><strong>作用</strong></p> <ul><li>防火墙作用：不想暴露真正的服务器，可以是用<code>nginx</code>作为中间层，同时也能过滤到一些非法请求</li> <li>负载均衡</li></ul> <p>主要使用<code>proxy_pass</code>指令来实现反向代理</p> <h2 id="https-配置"><a href="#https-配置" class="header-anchor">#</a> Https 配置</h2> <p>参考这里<a href="https://shimingw.cn/docs/2020-02-07-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA-SSL%E7%9A%84%E7%94%B3%E8%AF%B7%E4%B8%8E%E9%83%A8%E7%BD%B2/#ssl%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7%E6%AD%A5%E9%AA%A4" target="_blank" rel="noopener noreferrer">SSL 的申请与部署<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="适配-pc-与移动环境"><a href="#适配-pc-与移动环境" class="header-anchor">#</a> 适配 PC 与移动环境</h2> <p>当用户从移动端打开 PC 端 baidu.com 的场景时，将自动跳转指移动端 m.baidu.com，本质上是 Nginx 可以通过内置变量$http_user_agent，获取到请求客户端的 userAgent。</p> <p>从而知道当前用户当前终端是移动端还是 PC，进而重定向到 H5 站还是 PC 站。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
 <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token comment"># 移动、pc设备agent获取</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token string">'(Android|webOS|iPhone)'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">set</span> <span class="token variable">$mobile_request</span> <span class="token string">'1'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$mobile_request</span> <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="优化手段"><a href="#优化手段" class="header-anchor">#</a> 优化手段</h2> <h3 id="配置-gzip"><a href="#配置-gzip" class="header-anchor">#</a> 配置 gzip</h3> <blockquote><p>开启 Nginx gzip，压缩后,静态资源的大小会大大的减少,从而可以节约大量的带宽,提高传输效率.</p></blockquote> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span><span class="token punctuation">{</span>
    <span class="token keyword">gzip</span> on<span class="token punctuation">;</span> <span class="token comment">#启动</span>
    <span class="token comment">#gzip_buffer number size 指定申请缓存空间的个数和每个空间的大小,size为内存页一页的大小getconf PAGE_SIZE</span>
    <span class="token keyword">gzip_buffers</span> <span class="token number">4</span> <span class="token number">8</span>K<span class="token punctuation">;</span>
    <span class="token keyword">gzip_comp_level</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">#压缩级别，1-10，数字越大压缩的越小，但是消耗cpu</span>
    <span class="token keyword">gzip_min_length</span> <span class="token number">1</span>k<span class="token punctuation">;</span> <span class="token comment">#不压缩临界值，一般为1kb以上</span>
    <span class="token keyword">gzip_types</span> application<span class="token operator">/</span>javascript text<span class="token operator">/</span>css text<span class="token operator">/</span>xml<span class="token punctuation">;</span>    <span class="token comment">#匹配压缩类型</span>
    <span class="token keyword">gzip_disable</span> <span class="token string">&quot;MSIE [1-6]\.&quot;</span><span class="token punctuation">;</span> <span class="token comment"># IE6对Gzip不友好，指定哪些浏览器不需要压缩</span>
    <span class="token keyword">gzip_vary</span> on<span class="token punctuation">;</span> <span class="token comment">#启用应答头&quot;Vary: Accept-Encoding&quot;，告诉数据接收方数据进行了压缩</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对比一下压缩前后整个的<strong>load</strong>时间，缩短了<strong>83%</strong></p> <p>压缩前</p> <p><img src="https://wx3.sinaimg.cn/mw690/a0940ce6gy1gde92tlh4ej20qk0hh0v5.jpg" alt="压缩前"></p> <p>压缩后</p> <p><img src="https://wx4.sinaimg.cn/mw690/a0940ce6gy1gde92o96tfj20sb0hpmzn.jpg" alt="压缩后"></p> <h3 id="禁用页面资源请求的记录"><a href="#禁用页面资源请求的记录" class="header-anchor">#</a> 禁用页面资源请求的记录</h3> <p>如果您不需要记录检索普通页面资源（例如图像，JavaScript 文件和 CSS 文件）的请求，则这是一种快速简便的解决方案。您需要做的就是创建一个<a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#location" target="_blank" rel="noopener noreferrer"><code>location</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>与这些文件类型匹配的新块，并禁用其中的日志记录。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">:</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>gif<span class="token operator">|</span>png<span class="token operator">|</span>ico<span class="token operator">|</span>woff2<span class="token operator">|</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
    <span class="token keyword">access_log</span> off<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="禁用成功请求的日志记录"><a href="#禁用成功请求的日志记录" class="header-anchor">#</a> 禁用成功请求的日志记录</h3> <p>使用<a href="https://nginx.org/en/docs/http/ngx_http_log_module.html#access_log" target="_blank" rel="noopener noreferrer">官方 NGINX 文档中<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的示例，让我们打开条件日志记录。创建一个变量<code>$loggable</code>，并将其设置为，<code>0</code>以使用和代码进行请求，否则设置为 。然后在指令中将此变量作为条件引用。<code>2*xx*``3*xx*``1``access_log</code></p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 修改前</span>
<span class="token keyword">access_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

<span class="token comment">#修改后</span>
<span class="token keyword">map</span> <span class="token variable">$status</span> <span class="token variable">$loggable</span> <span class="token punctuation">{</span>
    <span class="token operator">~</span><span class="token operator">^</span><span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span> <span class="token number">0</span><span class="token punctuation">;</span>
    default <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">access_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log combined <span class="token keyword">if</span><span class="token operator">=</span><span class="token variable">$loggable</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="使用缓冲来最小化-i-o-操作"><a href="#使用缓冲来最小化-i-o-操作" class="header-anchor">#</a> 使用缓冲来最小化 I / O 操作</h3> <p>即使您要记录所有请求，也可以通过打开访问日志缓冲来最大程度地减少 I / O 操作。使用此指令，NGINX 会等待将日志数据写入磁盘，直到填满 512 KB 缓冲区或自上次刷新以来经过 1 分钟（以先发生者为准）。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">access_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log combined buffer<span class="token operator">=</span><span class="token number">512</span>k flush<span class="token operator">=</span><span class="token number">1</span>m<span class="token punctuation">;</span>
</code></pre></div><h3 id="限制特定-url-的带宽"><a href="#限制特定-url-的带宽" class="header-anchor">#</a> 限制特定 URL 的带宽</h3> <p>如果服务器提供较大的文件（或较小但非常受欢迎的文件）</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 使用limit_rate指令限制特定URL的带宽。</span>
<span class="token comment"># 将/ download 下每个文件的传输速率限制为每秒50 KB。</span>
<span class="token keyword">location</span> <span class="token operator">/</span>download<span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">limit_rate</span> <span class="token number">50</span>k<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="使用-http-2"><a href="#使用-http-2" class="header-anchor">#</a> 使用 HTTP/2</h3> <ul><li>与 HTTP / 1.x 相比，使用的 TCP 连接更少</li> <li>NGINX 1.9.5 和更高版本</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/shimingw/vpblog/edit/master/docs/服务器搭建/02.nginx.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新于:</span> <span class="time">2020-5-19 5:55:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/2020-02-07-服务器搭建-SSL的申请与部署/" class="prev">
        SSL的申请与部署
      </a></span> <span class="next"><a href="/docs/2018-03-25-服务器搭建-Linux/">
        Linux
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div class="pace  pace-inactive" style="display:none;" data-v-57a75e74><div data-progress-text="100%" data-progress="99" class="pace-progress" style="transform:translate3d(0%, 0px, 0px);" data-v-57a75e74><div class="pace-progress-inner" data-v-57a75e74></div></div></div><div class="my-popup" style="display:none;" data-v-3414bdeb><div class="my-popup-container" data-v-3414bdeb><div class="my-popup-exit" data-v-3414bdeb></div> <img src="" alt data-v-3414bdeb></div></div><!----><!----><div></div></div></div>
    <script src="/assets/js/app.82d5831e.js" defer></script><script src="/assets/js/2.8423ab85.js" defer></script><script src="/assets/js/66.94449ac4.js" defer></script><script src="/assets/js/5.d4f27e5e.js" defer></script>
  </body>
</html>
