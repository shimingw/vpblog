---
title: "React源码解析"
date: 2020-05-15
category: React
permalink: "2020-05-15-React-React源码解析"
---
## React源码调试方法

借助`react`的单元测试可以进行源码的调试

1. 配置`vscode`的`launch.json`文件

   第一个配置执行所有的测试用例

   第二个配置是执行当前打开的测试用例，一般使用第二个

   ```json
   {
       "version": "0.2.0",
       "configurations": [
         {
           "type": "node",
           "request": "launch",
           "name": "Jest All",
           "program": "${workspaceFolder}/node_modules/.bin/jest",
           "args": [
             "--config",
             "./scripts/jest/config.source.js",
             "--runInBand"
           ],
           "console": "integratedTerminal",
           "internalConsoleOptions": "neverOpen",
           "disableOptimisticBPs": true,
           "windows": {
             "program": "${workspaceFolder}/node_modules/jest/bin/jest",
           },
           "env": {
             "NODE_ENV": "development"
           }
         },
         {
           "type": "node",
           "request": "launch",
           "name": "Jest Current File",
           "program": "${workspaceFolder}/node_modules/.bin/jest",
           "args": [
             "${fileBasenameNoExtension}",
             "--config",
             "./scripts/jest/config.source.js",
             "--runInBand"
           ],
           "console": "integratedTerminal",
           "internalConsoleOptions": "neverOpen",
           "disableOptimisticBPs": true,
           "env": {
             "NODE_ENV": "development"
           },
           "windows": {
             "program": "${workspaceFolder}/node_modules/jest/bin/jest",
           }
         }
       ]
     }
   ```

2. 配置`Jest`对代码编译的`sourceMap`

   需要在`scripts/jest/preprocessor.js`的`babel`配置中添加`sourceMaps: 'both'`或者`sourceMaps: 'inline'`

   ```js {25}
   const babelOptions = {
     plugins: [
       // For Node environment only. For builds, Rollup takes care of ESM.
       require.resolve('@babel/plugin-transform-modules-commonjs'),
   
       pathToBabelPluginDevWithCode,
   
       // Keep stacks detailed in tests.
       // Don't put this in .babelrc so that we don't embed filenames
       // into ReactART builds that include JSX.
       // TODO: I have not verified that this actually works.
       require.resolve('@babel/plugin-transform-react-jsx-source'),
   
       pathToTransformInfiniteLoops,
       pathToTransformTestGatePragma,
   
       // This optimization is important for extremely performance-sensitive (e.g. React source).
       // It's okay to disable it for tests.
       [
         require.resolve('@babel/plugin-transform-block-scoping'),
         {throwIfClosureRequired: false},
       ],
     ],
     retainLines: true,
     sourceMaps: 'both'
   };
   ```

3. 在单元测试中打上断点`packages\react-dom\src\__tests__`，执行`debugger`，即可实现断点调试