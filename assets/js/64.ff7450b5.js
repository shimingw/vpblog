(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{295:function(t,s,a){"use strict";a.r(s);var e=a(10),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"http-协议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-协议"}},[t._v("#")]),t._v(" http 协议")]),t._v(" "),a("p",[a("strong",[t._v("请求头")])]),t._v(" "),a("p",[a("code",[t._v("Connection")]),t._v("：close 和 keep-alive。是否支持长连接。长连接可以重用 http 请求资源，减少资源开销\n"),a("code",[t._v("Host")]),t._v("：发起请求的域名或者 ip\n"),a("code",[t._v("etag")]),t._v("：被请求变量的实体值，nginx 会给每个静态资源打上一个 etag 标签，客户端每次请求的时候会带上"),a("code",[t._v("If-None-Match")]),t._v("如果 nginx 的资源没有发生变化，则 Etag 标签不会发生改变。浏览器会返回 304，服务器就从缓存中读取资源。")]),t._v(" "),a("h2",{attrs:{id:"常用变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用变量"}},[t._v("#")]),t._v(" 常用变量")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("$http_host")]),t._v("：客户端请求头中携带的 host")]),t._v(" "),a("li",[a("code",[t._v("$host")]),t._v("：nginx 服务器的域名或者 ip")]),t._v(" "),a("li",[a("code",[t._v("$proxy_port")]),t._v("："),a("strong",[t._v("proxy_pass")]),t._v("对应后端服务器的端口")]),t._v(" "),a("li",[a("code",[t._v("$remote_addr")]),t._v("：用户 ip")]),t._v(" "),a("li",[a("code",[t._v("$proxy_add_x_forwarded_for")]),t._v("：添加用户 ip 和每次 nginx 反向代理服务器的 ip 用逗号隔开，起到一个溯源的作用。")])]),t._v(" "),a("h2",{attrs:{id:"常用指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用指令"}},[t._v("#")]),t._v(" 常用指令")]),t._v(" "),a("p",[a("strong",[t._v("proxy_set_header")])]),t._v(" "),a("blockquote",[a("p",[t._v("允许重新定义或者添加发往后端服务器的请求头")])]),t._v(" "),a("p",[t._v("Host")]),t._v(" "),a("p",[t._v("默认情况下，只有两个请求头会被重新定义："),a("code",[t._v("Host")]),t._v("和"),a("code",[t._v("Connection")])]),t._v(" "),a("p",[t._v("如果不想改变请求头“Host”的值，可以这样来设置：\n"),a("code",[t._v("proxy_set_header Host $http_host;")])]),t._v(" "),a("p",[a("strong",[t._v("websocket")])]),t._v(" "),a("p",[t._v("nginx 代理转发 websocket 请求")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" Upgrade "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_upgrade")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" Connection "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"upgrade"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("长链接如果长时间没有响应会被"),a("code",[t._v("nginx")]),t._v("中断\n解决方案1\n修改"),a("code",[t._v("timeout")]),t._v("时间")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_connect_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_read_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_send_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("解决方案2\n定时发送心跳包")]),t._v(" "),a("p",[a("strong",[t._v("proxy_connect_timeout")])]),t._v(" "),a("blockquote",[a("p",[t._v("设置与后端服务器建立连接的超时时间。应该注意这个超时一般不可能大于 75 秒。默认 60s")])]),t._v(" "),a("p",[a("strong",[t._v("proxy_read_timeout")])]),t._v(" "),a("blockquote",[a("p",[t._v("定义从后端服务器读取响应的超时。此超时是指相邻两次读操作之间的最长时间间隔，而不是整个响应传输完成的最长时间。如果后端服务器在超时时间段内没有传输任何数据，连接将被关闭。")])]),t._v(" "),a("p",[a("strong",[t._v("proxy_send_timeout")])]),t._v(" "),a("blockquote",[a("p",[t._v("定义向后端服务器传输请求的超时。此超时是指相邻两次写操作之间的最长时间间隔，而不是整个请求传输完成的最长时间。如果后端服务器在超时时间段内没有接收到任何数据，连接将被关闭。")])]),t._v(" "),a("p",[a("strong",[t._v("proxy_pass")])]),t._v(" "),a("blockquote",[a("p",[t._v("设置后端服务器的协议和地址")])]),t._v(" "),a("h2",{attrs:{id:"负载均衡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡"}},[t._v("#")]),t._v(" 负载均衡")]),t._v(" "),a("p",[a("strong",[t._v("轮询（默认）")])]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" backserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("权重weight")])]),t._v(" "),a("p",[t._v("指定不同ip的权重，权重与访问比成正相关，权重越高，访问越大，适用于不同性能的机器。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" backserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),t._v(" weight"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".2")]),t._v(" weight"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("响应时间来分配")])]),t._v(" "),a("p",[t._v("公平竞争，谁相应快，谁处理，不过这种方式需要依赖到第三方插件"),a("code",[t._v("nginx-upstream-fair")]),t._v("，需要先安装。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" backserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    fair"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"健康检查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#健康检查"}},[t._v("#")]),t._v(" 健康检查")]),t._v(" "),a("p",[a("strong",[t._v("Nginx")]),t._v("自带"),a("code",[t._v("ngx_http_upstream_module")]),t._v(" （健康检测模块）本质上服务器心跳的检查，通过定期轮询向集群里的服务器发送健康检查请求,来检查集群中是否有服务器处于异常状态。")]),t._v(" "),a("p",[t._v("如果检测出其中某台服务器异常,那么在通过客户端请求nginx反向代理进来的都不会被发送到该服务器上（直至下次轮训健康检查正常）")]),t._v(" "),a("p",[a("strong",[t._v("判断异常依据"),a("code",[t._v("proxy_next_upstream")]),t._v("的配置")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Syntax: proxy_next_upstream error | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | non_idempotent | off ...;\nDefault:    proxy_next_upstream error timeout;\nContext:    http, server, location\n")])])]),a("ul",[a("li",[t._v("error:在与服务器建立连接，向其传递请求或读取响应标头时发生错误;")]),t._v(" "),a("li",[t._v("timeout:在与服务器建立连接，向其传递请求或读取响应头时发生超时;")]),t._v(" "),a("li",[t._v("invalid_header:服务器返回空响应或无效响应;")]),t._v(" "),a("li",[t._v("http_500:服务器返回了带有代码500的响应;")]),t._v(" "),a("li",[t._v("http_502:服务器返回具有代码502的响应;")]),t._v(" "),a("li",[t._v("HTTP_503:服务器返回具有代码503的响应;")]),t._v(" "),a("li",[t._v("http_504:服务器返回具有代码504的响应;")]),t._v(" "),a("li",[t._v("http_403:服务器返回带有代码403的响应;")]),t._v(" "),a("li",[t._v("http_404:服务器返回具有代码404的响应;")]),t._v(" "),a("li",[t._v("non_idempotent:通常，如果请求已经被发送到上游服务器（1.9.13），则具有非幂等方法的请求（POST，LOCK，PATCH）不被传递到下一个服务器;启用此选项明确允许重试此类请求;")]),t._v(" "),a("li",[t._v("off:禁用将请求传递到下一个服务器。")])]),t._v(" "),a("p",[a("strong",[t._v("配置参数")])]),t._v(" "),a("ul",[a("li",[t._v("max_fails：设定Nginx与服务器通信的尝试失败的次数，默认为：1次")]),t._v(" "),a("li",[t._v("fail_timeout：设定服务器被认为不可用的时间段以及统计失败尝试次数的时间段，默认为10s")])]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" backserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),t._v("  max_fails"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" fail_timeout"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".2")]),t._v("  max_fails"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" fail_timeout"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"反向代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#反向代理"}},[t._v("#")]),t._v(" 反向代理")]),t._v(" "),a("p",[t._v("将一个请求转发到另一个资源（可以是另一台服务器，也可以使本服务器的指定目录）")]),t._v(" "),a("p",[a("strong",[t._v("作用")])]),t._v(" "),a("ul",[a("li",[t._v("防火墙作用：不想暴露真正的服务器，可以是用"),a("code",[t._v("nginx")]),t._v("作为中间层，同时也能过滤到一些非法请求")]),t._v(" "),a("li",[t._v("负载均衡")])]),t._v(" "),a("p",[t._v("主要使用"),a("code",[t._v("proxy_pass")]),t._v("指令来实现反向代理")]),t._v(" "),a("h2",{attrs:{id:"https-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#https-配置"}},[t._v("#")]),t._v(" Https 配置")]),t._v(" "),a("p",[t._v("参考这里"),a("a",{attrs:{href:"https://shimingw.cn/docs/2020-02-07-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA-SSL%E7%9A%84%E7%94%B3%E8%AF%B7%E4%B8%8E%E9%83%A8%E7%BD%B2/#ssl%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7%E6%AD%A5%E9%AA%A4",target:"_blank",rel:"noopener noreferrer"}},[t._v("SSL的申请与部署"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"适配pc与移动环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#适配pc与移动环境"}},[t._v("#")]),t._v(" 适配PC与移动环境")]),t._v(" "),a("p",[t._v("当用户从移动端打开PC端baidu.com的场景时，将自动跳转指移动端m.baidu.com，本质上是Nginx可以通过内置变量$http_user_agent，获取到请求客户端的userAgent。")]),t._v(" "),a("p",[t._v("从而知道当前用户当前终端是移动端还是PC，进而重定向到H5站还是PC站。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 移动、pc设备agent获取")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_user_agent")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'(Android|webOS|iPhone)'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$mobile_request")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$mobile_request")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("baidu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"优化手段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优化手段"}},[t._v("#")]),t._v(" 优化手段")]),t._v(" "),a("h3",{attrs:{id:"配置gzip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置gzip"}},[t._v("#")]),t._v(" 配置gzip")]),t._v(" "),a("blockquote",[a("p",[t._v("开启Nginx gzip，压缩后,静态资源的大小会大大的减少,从而可以节约大量的带宽,提高传输效率.")])]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip")]),t._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#启动")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#gzip_buffer number size 指定申请缓存空间的个数和每个空间的大小,size为内存页一页的大小getconf PAGE_SIZE")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_buffers")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("K"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_comp_level")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#压缩级别，1-10，数字越大压缩的越小，但是消耗cpu")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_min_length")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#不压缩临界值，一般为1kb以上")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_types")]),t._v(" application"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("javascript text"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("css text"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("xml"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#匹配压缩类型")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_disable")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MSIE [1-6]\\."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# IE6对Gzip不友好，指定哪些浏览器不需要压缩")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_vary")]),t._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#启用应答头"Vary: Accept-Encoding"，告诉数据接收方数据进行了压缩')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("对比一下压缩前后整个的"),a("strong",[t._v("load")]),t._v("时间，缩短了"),a("strong",[t._v("83%")])]),t._v(" "),a("p",[t._v("压缩前")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://wx3.sinaimg.cn/mw690/a0940ce6gy1gde92tlh4ej20qk0hh0v5.jpg",alt:"压缩前"}})]),t._v(" "),a("p",[t._v("压缩后")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://wx4.sinaimg.cn/mw690/a0940ce6gy1gde92o96tfj20sb0hpmzn.jpg",alt:"压缩后"}})]),t._v(" "),a("h3",{attrs:{id:"禁用页面资源请求的记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#禁用页面资源请求的记录"}},[t._v("#")]),t._v(" 禁用页面资源请求的记录")]),t._v(" "),a("p",[t._v("如果您不需要记录检索普通页面资源（例如图像，JavaScript文件和CSS文件）的请求，则这是一种快速简便的解决方案。您需要做的就是创建一个"),a("a",{attrs:{href:"https://nginx.org/en/docs/http/ngx_http_core_module.html#location",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("location")]),a("OutboundLink")],1),t._v("与这些文件类型匹配的新块，并禁用其中的日志记录。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" \\"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("jpg"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("jpeg"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("gif"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("png"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("ico"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("woff2"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("js"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("css"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"禁用成功请求的日志记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#禁用成功请求的日志记录"}},[t._v("#")]),t._v(" 禁用成功请求的日志记录")]),t._v(" "),a("p",[t._v("使用"),a("a",{attrs:{href:"https://nginx.org/en/docs/http/ngx_http_log_module.html#access_log",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方NGINX文档中"),a("OutboundLink")],1),t._v("的示例，让我们打开条件日志记录。创建一个变量"),a("code",[t._v("$loggable")]),t._v("，并将其设置为，"),a("code",[t._v("0")]),t._v("以使用和代码进行请求，否则设置为 。然后在指令中将此变量作为条件引用。"),a("code",[t._v("2*xx*``3*xx*``1``access_log")])]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改前")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("log"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("access"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#修改后")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$status")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$loggable")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    default "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("log"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("access"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log combined "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$loggable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"使用缓冲来最小化i-o操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用缓冲来最小化i-o操作"}},[t._v("#")]),t._v(" 使用缓冲来最小化I / O操作")]),t._v(" "),a("p",[t._v("即使您要记录所有请求，也可以通过打开访问日志缓冲来最大程度地减少I / O操作。使用此指令，NGINX会等待将日志数据写入磁盘，直到填满512 KB缓冲区或自上次刷新以来经过1分钟（以先发生者为准）。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("log"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("access"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log combined buffer"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("512")]),t._v("k flush"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"限制特定url的带宽"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#限制特定url的带宽"}},[t._v("#")]),t._v(" 限制特定URL的带宽")]),t._v(" "),a("p",[t._v("如果服务器提供较大的文件（或较小但非常受欢迎的文件）")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用limit_rate指令限制特定URL的带宽。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将/ download 下每个文件的传输速率限制为每秒50 KB。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("download"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("limit_rate")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("50")]),t._v("k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"使用http-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用http-2"}},[t._v("#")]),t._v(" 使用HTTP/2")]),t._v(" "),a("ul",[a("li",[t._v("与HTTP / 1.x相比，使用的TCP连接更少")]),t._v(" "),a("li",[t._v("NGINX 1.9.5和更高版本")])]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),t._v(" http2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);